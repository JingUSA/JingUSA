"0",""
"0","# Charts #1–#4  |  Alternative robust version (no tidytext)"
"0",""
"0","suppressPackageStartupMessages({"
"0","  library(readr); library(dplyr); library(tidyr)"
"0","  library(ggplot2); library(scales); library(lubridate)"
"0","  library(stringr); library(forcats)"
"0","})"
"0","options(scipen = 999)"
"0",""
"0","# ---------- 0) Load & clean ----------"
"0","csv_path <- ""/Users/jingtao/Desktop/FALL 2025/DATA VISUALIZATION/Jing Tao/owid-covid-data.csv""   "
"0","owid <- read_csv(csv_path, show_col_types = FALSE)"
"0"," "
"0","need <- c(""continent"",""location"",""date"",""population"",""total_cases"",""gdp_per_capita"")"
"0","stopifnot(all(need %in% names(owid)))"
"0",""
"0","latest <- owid %>%"
"0","  select(all_of(need)) %>%"
"0","  filter(!is.na(continent), !is.na(population), population > 0) %>%"
"0","  mutate(date_clean = ymd(str_sub(as.character(date), 1, 10), quiet = TRUE)) %>%"
"0","  filter(!is.na(date_clean)) %>%"
"0","  group_by(location) %>%"
"0","  slice_max(order_by = date_clean, n = 1, with_ties = FALSE) %>%"
"0","  ungroup()"
"0",""
"0","df <- latest %>%"
"0","  transmute("
"0","    Continent  = continent,"
"0","    Country    = location,"
"0","    Population = as.numeric(population) / 1e6,   # 百万人"
"0","    Cases      = as.numeric(total_cases),"
"0","    GDP        = as.numeric(gdp_per_capita)"
"0","  )"
"0",""
"0","if (!dir.exists(""outputs"")) dir.create(""outputs"", recursive = TRUE)"
"0","stamp <- format(Sys.time(), ""%Y%m%d_%H%M%S"")"
"0","save_png <- function(p, name, w=12, h=7, dpi=300){"
"0","  fn <- file.path(""outputs"", paste0(name, ""_"", stamp, "".png""))"
"0","  ggsave(fn, p, width=w, height=h, dpi=dpi); message(""Saved: "", fn)"
"0","}"
"0",""
"0","# Chart 1 — Variable Width Column"
"0","wrap_cont <- function(x) gsub("" "", ""\n"", x)"
"0",""
"0","mekko <- df %>%"
"0","  group_by(Continent) %>%"
"0","  summarise("
"0","    pop_sum = sum(Population, na.rm = TRUE),"
"0","    cases_median = median(Cases, na.rm = TRUE),"
"0","    .groups = ""drop"""
"0","  ) %>%"
"0","  arrange(Continent) %>%"
"0","  mutate("
"0","    width_share = pop_sum / sum(pop_sum),"
"0","    xmin = lag(cumsum(width_share), default = 0),"
"0","    xmax = cumsum(width_share),"
"0","    xmid = (xmin + xmax) / 2,"
"0","    Cont_lbl = wrap_cont(Continent)"
"0","  )"
"0",""
"0","p1 <- ggplot(mekko) +"
"0","  geom_rect(aes(xmin=xmin, xmax=xmax, ymin=0, ymax=cases_median, fill=Continent),"
"0","            color=""white"") +"
"0","  scale_x_continuous(breaks=mekko$xmid, labels=mekko$Cont_lbl, expand=c(0.02,0)) +"
"0","  scale_y_continuous(labels=label_comma()) +"
"0","  labs("
"0","    title=""Chart 1 — Variable Width Column Chart"","
"0","    subtitle=""Width = population share (millions); Height = median total cases (latest per country)"","
"0","    x=""Continent (bar width ∝ population share)"", y=""Median Total Cases"""
"0","  ) +"
"0","  theme_minimal(base_size=13) +"
"0","  theme(legend.position=""none"", plot.title=element_text(face=""bold""))"
"0","save_png(p1, ""A4_chart1_mekko"")"
"0",""
"0",""
"0","# Chart 2 — Table with Embedded Charts"
"0",""
"0","top6_tbl <- df %>%"
"0","  slice_max(order_by = Cases, n = 6, with_ties = FALSE) %>%"
"0","  select(Country, Population, GDP)"
"0",""
"0","long2 <- top6_tbl %>%"
"0","  pivot_longer(c(Population, GDP), names_to = ""Metric"", values_to = ""Value"") %>%"
"0","  group_by(Metric) %>%"
"0","  mutate(Value_scaled = Value / max(Value, na.rm = TRUE)) %>%"
"0","  ungroup()"
"0",""
"0","p2 <- ggplot(long2, aes(x = 1, y = Value_scaled)) +"
"0","  geom_col(width = 0.6, fill = ""#6baed6"") +"
"0","  facet_grid(rows = vars(Country), cols = vars(Metric), switch = ""y"") +"
"0","  coord_cartesian(ylim = c(0,1)) +"
"0","  labs("
"0","    title=""Chart 2 — Table with Embedded Charts (ggplot-only)"","
"0","    subtitle=""Rows = Top-6 by Cases; Columns = Population (M) & GDP per capita (scaled within column)"","
"0","    x=NULL, y=NULL"
"0","  ) +"
"0","  theme_minimal(base_size=13) +"
"0","  theme("
"0","    axis.text=element_blank(), axis.ticks=element_blank(), panel.grid=element_blank(),"
"0","    strip.placement=""outside"","
"0","    strip.background=element_rect(fill=""grey95"", color=NA),"
"0","    panel.border=element_rect(color=""grey70"", fill=NA, linewidth=0.5),"
"0","    plot.title=element_text(face=""bold""),"
"0","    plot.margin=margin(10,10,10,16)"
"0","  )"
"0","save_png(p2, ""A4_chart2_table_embedded"")"
"0",""
"0","# Chart 3 — Horizontal Bar (Many items, Few categories)"
"0",""
"0","df3 <- df %>%"
"0","  group_by(Continent) %>%"
"0","  slice_max(order_by = Cases, n = 8, with_ties = FALSE) %>%"
"0","  ungroup() %>%"
"0","  mutate("
"0","    y_comb = paste(Continent, Country, sep = "" | "")"
"0","  ) %>%"
"0","  group_by(Continent) %>%"
"0","  arrange(Cases, .by_group = TRUE) %>%"
"0","  mutate("
"0","    # 在各洲内部设置因子顺序（从小到大，条形从下到上）"
"0","    y_comb = factor(y_comb, levels = unique(y_comb))"
"0","  ) %>%"
"0","  ungroup()"
"0",""
"0","# 只显示国家名的 labeller"
"0","only_country <- function(x) sub(""^.*\\|\\s*"", """", x)"
"0",""
"0","p3 <- ggplot(df3, aes(x = Cases, y = y_comb)) +"
"0","  geom_col(fill = ""#74c476"") +"
"0","  facet_wrap(~ Continent, nrow = 1, scales = ""free_y"") +"
"0","  scale_y_discrete(labels = only_country) +"
"0","  scale_x_continuous(labels = label_comma()) +"
"0","  labs("
"0","    title = ""Chart 3 — Horizontal Bar Chart (Many Items, Few Categories)"","
"0","    subtitle = ""Top 8 countries by total cases within each continent (latest per country)"","
"0","    x = ""Total Cases"", y = ""Country"""
"0","  ) +"
"0","  theme_minimal(base_size = 13) +"
"0","  theme(plot.title = element_text(face = ""bold""))"
"0","save_png(p3, ""A4_chart3_bar_faceted"")"
"0",""
"0","# --------------------------------------------------------------"
"0","# Chart 4 — Column Chart (Few items)"
"0","# --------------------------------------------------------------"
"0","agg4 <- df %>%"
"0","  group_by(Continent) %>%"
"0","  summarise(median_gdp_pc = median(GDP, na.rm = TRUE), .groups = ""drop"")"
"0",""
"0","p4 <- ggplot(agg4, aes(x = Continent, y = median_gdp_pc, fill = Continent)) +"
"0","  geom_col() +"
"0","  scale_y_continuous(labels = label_comma()) +"
"0","  labs("
"0","    title=""Chart 4 — Column Chart"","
"0","    subtitle=""Median GDP per capita by continent"","
"0","    x=""Continent"", y=""Median GDP per capita (USD)"""
"0","  ) +"
"0","  theme_minimal(base_size=13) +"
"0","  theme(legend.position=""none"", plot.title=element_text(face=""bold""))"
"0","save_png(p4, ""A4_chart4_column"")"
"0",""
